<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSM Nota Arşivi</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    h1 { margin-bottom: .25rem; }
    .sub { color: #666; font-size: 0.95rem; margin-bottom: 1rem; }
    input[type="search"] { width: 100%; max-width: 520px; padding: .6rem .8rem; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: .6rem .5rem; text-align: left; }
    th { font-weight: 600; }
    tr:hover { background: rgba(0,0,0,.03); }
    .muted { color: #777; font-size: .9rem; }
    .badge { display: inline-block; padding: .15rem .4rem; border-radius: 6px; border: 1px solid #d0d7de; font-size: .75rem; color: #444; background: #f6f8fa; }
    .footer { margin-top: 2rem; font-size: .9rem; color: #666; }
    a { color: #0a58ca; text-decoration: none; }
  </style>
</head>
<body>
  <h1>TSM Nota Arşivi</h1>
  <div class="sub">
    Arama yapabilir ve “Nota” sütunundan dosyayı açabilirsiniz. Dosyalar pdf, png, jpg, jpeg, gif, tif, tiff, webp olabilir.
    İsterseniz rows.json içinde her eser için "dosya" veya "url" alanı tanımlayın (örn: "dosya": "1.png").
  </div>

  <input id="q" type="search" placeholder="Ara: eser, makam, usul, bestekâr, söz..." aria-label="Tabloda ara" />

  <table id="tbl" aria-describedby="help">
    <thead>
      <tr>
        <th>Eser</th>
        <th>Makam</th>
        <th>Usul</th>
        <th>Bestekâr</th>
        <th>Söz</th>
        <th>Nota</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="help" class="footer">
    <span class="badge">İpucu</span>
    Otomatik tespit: notalar/&lt;id&gt;.[pdf|png|jpg|jpeg|gif|tif|tiff|webp].
    Elle belirtmek için rows.json’a "dosya" (örn: "3.tiff") veya tam "url" ekleyin.
  </div>

  <script>
    const state = { rows: [], filtered: [] };
    const tbody = document.querySelector('#tbl tbody');
    const q = document.getElementById('q');

    const CANDIDATE_EXTS = ['pdf','png','jpg','jpeg','gif','tif','tiff','webp'];
    const assetCache = new Map(); // id -> url

    function labelForUrl(url) {
      const m = (url || '').toLowerCase().match(/\.([a-z0-9]+)(?:\?|#|$)/);
      const ext = m ? m[1] : '';
      if (ext === 'pdf') return 'PDF';
      if (['png','jpg','jpeg','gif','tif','tiff','webp'].includes(ext)) return 'Görüntü';
      return 'Aç';
    }

    function normalize(t) {
      return (t || '').toString().toLocaleLowerCase('tr');
    }

    function render(rows) {
      tbody.innerHTML = rows.map(r => {
        const nid = `asset-${String(r.id ?? '').replace(/[^a-zA-Z0-9_-]/g,'')}`;
        const cached = r.id != null ? assetCache.get(r.id) : null;
        const linkHtml = cached
          ? `<a href="${cached}" target="_blank" rel="noopener">${labelForUrl(cached)}</a>`
          : '<span class="muted">—</span>';
        return `
          <tr>
            <td>${r.eser || ''}</td>
            <td>${r.makam || ''}</td>
            <td>${r.usul || ''}</td>
            <td>${r.bestekar || ''}</td>
            <td>${r.soz || ''}</td>
            <td id="${nid}">${linkHtml}</td>
          </tr>`;
      }).join('');

      // Bağlantısı olmayan satırlar için arka planda dosya tespiti yap
      rows.forEach(r => {
        if (r == null || r.id == null) return;
        if (assetCache.has(r.id)) return;
        resolveAsset(r).then(url => {
          if (!url) return;
          assetCache.set(r.id, url);
          const nid = `asset-${String(r.id).replace(/[^a-zA-Z0-9_-]/g,'')}`;
          const cell = document.getElementById(nid);
          if (cell) cell.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${labelForUrl(url)}</a>`;
        });
      });
    }

    async function resolveAsset(r) {
      // 1) rows.json içinde "url" varsa doğrudan kullan
      if (r.url && typeof r.url === 'string') return r.url;

      // 2) "dosya" (veya "file") verilmişse köke göre birleştir
      const fileField = r.dosya || r.file;
      if (fileField && typeof fileField === 'string') {
        // Tam URL mi yoksa notalar/ içinde bir dosya mı?
        if (/^https?:\/\//i.test(fileField)) return fileField;
        return `notalar/${fileField}`;
      }

      // 3) "ext" verilmişse notalar/<id>.<ext>
      if (r.ext && typeof r.ext === 'string') {
        return `notalar/${r.id}.${r.ext.replace(/^\./,'')}`;
      }

      // 4) Otomatik tespit: olası uzantıları HEAD ile sırayla dene
      for (const ext of CANDIDATE_EXTS) {
        const url = `notalar/${r.id}.${ext}`;
        try {
          const resp = await fetch(url, { method: 'HEAD', cache: 'no-store' });
          if (resp.ok) return url;
        } catch (_) {}
      }
      return null;
    }

    function applyFilter() {
      const needle = normalize(q.value);
      if (!needle) { render(state.rows); return; }
      const rows = state.rows.filter(r => {
        const hay = [r.eser, r.makam, r.usul, r.bestekar, r.soz].map(normalize).join(' ');
        return hay.includes(needle);
      });
      render(rows);
    }

    q.addEventListener('input', applyFilter);

    fetch('rows.json', { cache: 'no-store' })
      .then(r => r.ok ? r.json() : [])
      .then(rows => {
        state.rows = Array.isArray(rows) ? rows : [];
        render(state.rows);
      })
      .catch(() => { state.rows = []; render(state.rows); });
  </script>
</body>
</html>
