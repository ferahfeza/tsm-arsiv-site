<!doctype html>
<html lang="tr" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSM Nota Arşivi</title>

  <!-- Sayfa yüklenmeden önce temayı ayarla (flicker'ı azaltır) -->
  <script>
    (function () {
      try {
        var stored = localStorage.getItem('theme'); // 'light' | 'dark' | 'auto'
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var initial = stored === 'auto' || !stored ? (prefersDark ? 'dark' : 'light') : stored;
        document.documentElement.setAttribute('data-bs-theme', initial);
      } catch (_) {
        document.documentElement.setAttribute('data-bs-theme', 'light');
      }
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <!-- Markdown render -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" crossorigin="anonymous"></script>

  <style>
    :root, [data-bs-theme="light"] { color-scheme: light; }
    [data-bs-theme="dark"] { color-scheme: dark; }

    header .toolbar { gap: .5rem; }

    .sortable { cursor: pointer; user-select: none; position: relative; }
    .sortable:hover { background-color: var(--bs-secondary-bg); }
    .sort-icon { font-size: 0.8em; color: #6c757d; margin-left: 0.25rem; }
    .sortable.sort-asc .sort-icon::before { content: "↑"; }
    .sortable.sort-desc .sort-icon::before { content: "↓"; }

    @media (max-width: 768px) {
      .table th, .table td { font-size: 0.875rem; padding: 0.5rem 0.25rem; }
    }

    /* Blog içeriği stilleri */
    .blog-title { margin-bottom: .5rem; }
    .blog-meta { color: #adb5bd; margin-bottom: 1rem; }
    .md-content img { max-width: 100%; height: auto; }
    .md-content pre { background: rgba(0,0,0,.05); padding: .75rem; border-radius: .25rem; overflow:auto; }
  </style>
</head>
<body class="bg-body-tertiary">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#/" data-nav="home">Klâsik Türk Müziği Nota Arşivi</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Menüyü Aç/Kapat">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav ms-auto mb-2 mb-md-0">
          <li class="nav-item"><a class="nav-link" href="#/" data-nav="home">Ana Sayfa</a></li>
          <li class="nav-item"><a class="nav-link" href="#/blog" data-nav="blog">Blog</a></li>
          <li class="nav-item"><a class="nav-link" href="#/hakkinda" data-nav="hakkinda">Hakkında</a></li>
          <li class="nav-item"><a class="nav-link" href="#/iletisim" data-nav="iletisim">İletişim</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-4">

    <!-- ANA SAYFA (liste) -->
    <div id="view-home">
      <header class="mb-2">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
          <div class="text-center text-md-start">
            <h2 class="display-6 fw-bold mb-4 text-center">Hoşgeldiniz!</h2>
          </div>

          <div class="toolbar d-flex align-items-center justify-content-center">
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Tema
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
                <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="light">🌞 Açık</button></li>
                <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="dark">🌙 Koyu</button></li>
                <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="auto">🖥️ Sistem</button></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="row justify-content-center">
          <div class="col-12 col-md-8 col-lg-6 mb-4">
            <input id="q" type="search" class="form-control form-control-lg" placeholder="Arama yapabilir ve “Nota” sütunundan dosyayı açabilirsiniz." aria-label="Tabloda ara" />
          </div>
        </div>
      </header>

      <section class="mb-4">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="makamFilter" class="form-label">Makam Filtresi</label>
            <select id="makamFilter" class="form-select">
              <option value="">Tümü</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="composerFilter" class="form-label">Bestekâr Filtresi</label>
            <select id="composerFilter" class="form-select">
              <option value="">Tümü</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="usulFilter" class="form-label">Usûl Filtresi</label>
            <select id="usulFilter" class="form-select">
              <option value="">Tümü</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="formFilter" class="form-label">Form Filtresi</label>
            <select id="formFilter" class="form-select">
              <option value="">Tümü</option>
            </select>
          </div>
        </div>
      </section>

      <div class="table-responsive">
        <table id="tbl" class="table table-hover align-middle" aria-describedby="help">
          <thead class="table-light">
            <tr>
              <th scope="col" class="sortable" data-sort="eser">Eser İsmi <i class="sort-icon">⇅</i></th>
              <th scope="col" class="sortable" data-sort="makam">Makam <i class="sort-icon">⇅</i></th>
              <th scope="col" class="sortable" data-sort="form">Form <i class="sort-icon">⇅</i></th>
              <th scope="col" class="sortable" data-sort="usul">Usûl <i class="sort-icon">⇅</i></th>
              <th scope="col" class="sortable" data-sort="bestekar">Bestekâr <i class="sort-icon">⇅</i></th>
              <th scope="col">Nota</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <section class="mt-3">
        <nav aria-label="Sayfalama">
          <ul id="pagination" class="pagination justify-content-center mb-0"></ul>
        </nav>
      </section>
    </div>

    <!-- BLOG -->
    <div id="view-blog" class="d-none">
      <div class="row">
        <div class="col-12 col-lg-4 mb-3">
          <h4 class="mb-3">Blog</h4>
          <ul id="blogList" class="list-group"></ul>
        </div>
        <div class="col-12 col-lg-8">
          <article id="blogContent" class="md-content">
            <h5 class="text-secondary">Bir yazı seçiniz.</h5>
          </article>
        </div>
      </div>
    </div>

    <!-- SAYFA (Hakkında / İletişim) -->
    <div id="view-page" class="d-none">
      <article id="pageContent" class="md-content"></article>
    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-body-tertiary border-top mt-5 text-white">
    <div class="container py-4">
      <div class="row">
        <div class="col-md-6">
          <h6 class="fw-bold">Türk Klasik Müziği Nota Arşivi</h6>
          <p>Bu arşiv, Türk Klasik Müziği eserlerinin notalarını araştırmacılar ve müzik severlerin erişimine sunmak amacıyla hazırlanmıştır.</p>
        </div>
        <div class="col-md-6">
          <h6 class="fw-bold">Arşiv İstatistikleri</h6>
          <div class="row">
            <div class="col-6 col-sm-4 mb-1">Toplam Eser: <strong id="totalPieces">0</strong></div>
            <div class="col-6 col-sm-4 mb-1">Form: <strong id="totalForms">0</strong></div>
            <div class="col-6 col-sm-4 mb-1">Makam: <strong id="totalMakams">0</strong></div>
            <div class="col-6 col-sm-4 mb-1">Bestekâr: <strong id="totalComposers">0</strong></div>
            <div class="col-6 col-sm-4 mb-1">Usûl: <strong id="totalUsuls">0</strong></div>
          </div>
        </div>
      </div>
      <hr class="my-3">
      <div class="row align-items-center">
        <div class="col-md-6">
          <p class="mb-0">© 2025 TSM Nota Arşivi - Hazırlayan: <a class="text-white text-decoration-underline" href="mailto:aihsan.canakoglu@dpu.edu.tr">Ali İhsan Çanakoğlu</a></p>
        </div>
        <div class="col-md-6 text-md-end">
          <p class="mb-0">Toplam <span id="footerStats">0</span> eser arşivlenmiştir.</p>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Tema yönetimi -->
  <script>
    (function () {
      var mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
      function getStored() { try { return localStorage.getItem('theme'); } catch (e) { return null; } }
      function setStored(v) { try { localStorage.setItem('theme', v); } catch (e) {} }
      function applyTheme(theme) {
        if (theme === 'auto') {
          document.documentElement.setAttribute('data-bs-theme', mql && mql.matches ? 'dark' : 'light');
        } else {
          document.documentElement.setAttribute('data-bs-theme', theme);
        }
        var items = document.querySelectorAll('[data-bs-theme-value]');
        for (var i = 0; i < items.length; i++) {
          var el = items[i];
          el.classList.toggle('active', el.getAttribute('data-bs-theme-value') === theme);
        }
      }
      if (mql && mql.addEventListener) {
        mql.addEventListener('change', function () {
          if (getStored() === 'auto') applyTheme('auto');
        });
      }
      window.addEventListener('DOMContentLoaded', function () {
        var current = getStored() || 'auto';
        applyTheme(current);
        var items = document.querySelectorAll('[data-bs-theme-value]');
        for (var i = 0; i < items.length; i++) {
          items[i].addEventListener('click', function (ev) {
            var theme = ev.currentTarget.getAttribute('data-bs-theme-value');
            setStored(theme);
            applyTheme(theme);
          });
        }
      });
    })();
  </script>

  <!-- Uygulama mantığı + Router -->
  <script>
    // Android uyumluluğu: Türkçe küçük harf/karşılaştırma için güvenli yardımcılar
    function safeLowerTR(s) {
      var str = (s == null ? '' : String(s));
      try { return str.toLocaleLowerCase(['tr']); }
      catch (_) { try { return str.toLocaleLowerCase(); } catch (e) { return str.toLowerCase(); } }
    }
    function cmpTR(a, b) {
      try { return String(a).localeCompare(String(b), 'tr', { sensitivity: 'base' }); }
      catch (_) { try { return String(a).localeCompare(String(b)); } catch (e) { return (a > b) - (a < b); } }
    }

    // Global state (liste)
    var state = { 
      rows: [], 
      filtered: [], 
      sortColumn: 'makam', 
      sortDirection: 'asc',
      activeFilters: { makam: '', composer: '', usul: '', form: '' },
      currentPage: 1,
      pageSize: 10
    };

    // Element refs
    var tbody = document.querySelector('#tbl tbody');
    var q = document.getElementById('q');
    var makamFilter = document.getElementById('makamFilter');
    var composerFilter = document.getElementById('composerFilter');
    var usulFilter = document.getElementById('usulFilter');
    var formFilter = document.getElementById('formFilter');
    var randomPieceBtn = document.getElementById('randomPiece');
    var pagination = document.getElementById('pagination');

    // Views
    var viewHome = document.getElementById('view-home');
    var viewBlog = document.getElementById('view-blog');
    var viewPage = document.getElementById('view-page');

    // Blog state
    var blogIndexLoaded = false;
    var blogPosts = []; // [{slug,title,date,file}, ...]

    var CANDIDATE_EXTS = ['pdf','png','jpg','jpeg','gif','tif','tiff','webp'];
    var assetCache = new Map(); // id -> url

    function labelForUrl(_) { return 'Görüntüle'; }
    function linkHtmlForUrl(url) {
      return '<a class="btn btn-sm btn-outline-primary" href="' + url + '" target="_blank" rel="noopener">' + labelForUrl(url) + '</a>';
    }

    // İstatistikleri güncelle
    function updateStatistics(rows) {
      function uniq(list) {
        var set = new Set();
        for (var i = 0; i < list.length; i++) { if (list[i]) set.add(list[i]); }
        return Array.from(set);
      }
      var uniqueMakams = uniq(rows.map(function(r){ return r.makam; }));
      var uniqueComposers = uniq(rows.map(function(r){ return r.bestekar; }));
      var uniqueUsuls = uniq(rows.map(function(r){ return r.usul; }));
      var uniqueForms = uniq(rows.map(function(r){ return r.form; }));
      var total = rows.length;

      var el;
      el = document.getElementById('totalPieces'); if (el) el.textContent = total;
      el = document.getElementById('totalForms'); if (el) el.textContent = uniqueForms.length;
      el = document.getElementById('totalMakams'); if (el) el.textContent = uniqueMakams.length;
      el = document.getElementById('totalComposers'); if (el) el.textContent = uniqueComposers.length;
      el = document.getElementById('totalUsuls'); if (el) el.textContent = uniqueUsuls.length;
      el = document.getElementById('footerStats'); if (el) el.textContent = total;
    }

    // Filtreleri doldur
    function populateFilters(rows) {
      function uniqueSorted(getter) {
        var set = new Set();
        for (var i = 0; i < rows.length; i++) {
          var v = getter(rows[i]);
          if (v) set.add(v);
        }
        var arr = Array.from(set);
        arr.sort(cmpTR);
        return arr;
      }
      var makams = uniqueSorted(function(r){ return r.makam; });
      var composers = uniqueSorted(function(r){ return r.bestekar; });
      var usuls = uniqueSorted(function(r){ return r.usul; });
      var forms = uniqueSorted(function(r){ return r.form; });

      makamFilter.innerHTML = '<option value="">Tümü</option>' + makams.map(function(m){ return '<option value="'+m+'">'+m+'</option>'; }).join('');
      composerFilter.innerHTML = '<option value="">Tümü</option>' + composers.map(function(c){ return '<option value="'+c+'">'+c+'</option>'; }).join('');
      usulFilter.innerHTML = '<option value="">Tümü</option>' + usuls.map(function(u){ return '<option value="'+u+'">'+u+'</option>'; }).join('');
      formFilter.innerHTML = '<option value="">Tümü</option>' + forms.map(function(f){ return '<option value="'+f+'">'+f+'</option>'; }).join('');
    }

    // Sıralama
    function sortRows(rows, column, direction) {
      var copy = rows.slice();
      copy.sort(function(a, b) {
        var valueA = a[column] == null ? '' : String(a[column]);
        var valueB = b[column] == null ? '' : String(b[column]);
        if (column === 'form') {
          valueA = a.form == null ? '' : String(a.form);
          valueB = b.form == null ? '' : String(b.form);
        }
        var res = cmpTR(valueA, valueB);
        return direction === 'asc' ? res : -res;
      });
      return copy;
    }

    // Filtreleme
    function filterRows(rows) {
      var searchNeedle = safeLowerTR(q.value);
      return rows.filter(function(r){
        if (searchNeedle) {
          var hay = [r.eser, r.makam, r.usul, r.bestekar, r.soz].map(safeLowerTR).join(' ');
          if (hay.indexOf(searchNeedle) === -1) return false;
        }
        if (state.activeFilters.makam && r.makam !== state.activeFilters.makam) return false;
        if (state.activeFilters.composer && r.bestekar !== state.activeFilters.composer) return false;
        if (state.activeFilters.usul && r.usul !== state.activeFilters.usul) return false;
        if (state.activeFilters.form && r.form !== state.activeFilters.form) return false;
        return true;
      });
    }

    function getPageNumbers(current, totalPages, delta) {
      if (delta == null) delta = 2;
      var range = [], pages = [], last;
      for (var i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= current - delta && i <= current + delta)) range.push(i);
      }
      for (var j = 0; j < range.length; j++) {
        var n = range[j];
        if (last) {
          if (n - last === 2) pages.push(last + 1);
          else if (n - last > 2) pages.push('…');
        }
        pages.push(n); last = n;
      }
      return pages;
    }

    function renderPagination(totalPages) {
      if (!pagination) return;
      var current = state.currentPage;
      var pages = getPageNumbers(current, totalPages);
      var prevDisabled = current <= 1 ? ' disabled' : '';
      var nextDisabled = current >= totalPages ? ' disabled' : '';
      var html = '';
      html += ''
        + '<li class="page-item' + prevDisabled + '">'
        + '  <a class="page-link" href="#" aria-label="Önceki" data-page="prev">'
        + '    <span aria-hidden="true">&laquo;</span>'
        + '  </a>'
        + '</li>';
      pages.forEach(function(p){
        if (p === '…') {
          html += '<li class="page-item disabled"><span class="page-link">…</span></li>';
        } else {
          var active = p === current ? ' active' : '';
          html += ''
            + '<li class="page-item' + active + '">'
            + '  <a class="page-link" href="#" data-page="' + p + '">' + p + '</a>'
            + ' </li>';
        }
      });
      html += ''
        + '<li class="page-item' + nextDisabled + '">'
        + '  <a class="page-link" href="#" aria-label="Sonraki" data-page="next">'
        + '    <span aria-hidden="true">&raquo;</span>'
        + '  </a>'
        + '</li>';
      pagination.innerHTML = html;
    }

    function applyHeaderSortClasses() {
      var headers = document.querySelectorAll('.sortable');
      for (var i = 0; i < headers.length; i++) headers[i].classList.remove('sort-asc', 'sort-desc');
      if (state.sortColumn) {
        var th = document.querySelector('.sortable[data-sort="' + state.sortColumn + '"]');
        if (th) th.classList.add(state.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
      }
    }

    // Sayfalama tıklamaları
    if (pagination) {
      pagination.addEventListener('click', function (e) {
        var a = e.target.closest && e.target.closest('a[data-page]');
        if (!a) return;
        e.preventDefault();

        var filteredLen = state.filtered && state.filtered.length ? state.filtered.length : 0;
        var totalPages = Math.max(1, Math.ceil(filteredLen / state.pageSize));
        var p = a.getAttribute('data-page');
        if (p === 'prev') {
          if (state.currentPage > 1) state.currentPage--;
        } else if (p === 'next') {
          if (state.currentPage < totalPages) state.currentPage++;
        } else {
          var num = parseInt(p, 10);
          if (!isNaN(num)) state.currentPage = Math.min(Math.max(num, 1), totalPages);
        }
        render(state.rows);
        var tbl = document.getElementById('tbl');
        if (tbl && tbl.scrollIntoView) tbl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    function render(rows) {
      try {
        var filteredRows = filterRows(rows);
        if (state.sortColumn) filteredRows = sortRows(filteredRows, state.sortColumn, state.sortDirection);
        state.filtered = filteredRows;

        var totalPages = Math.max(1, Math.ceil(filteredRows.length / state.pageSize));
        if (state.currentPage > totalPages) state.currentPage = 1;
        var start = (state.currentPage - 1) * state.pageSize;
        var pageRows = filteredRows.slice(start, start + state.pageSize);

        tbody.innerHTML = pageRows.map(function(r){
          var safeId = (r && r.id != null) ? String(r.id) : '';
          safeId = safeId.replace(/[^a-zA-Z0-9_-]/g,'');
          var nid = 'asset-' + safeId;
          var cached = (r && r.id != null) ? assetCache.get(r.id) : null;
          var linkHtml = cached ? linkHtmlForUrl(cached) : '<span class="text-secondary">—</span>';
          var form = r && r.form ? r.form : '';
          return ''
            + '<tr>'
            +   '<td>' + (r.eser || '') + '</td>'
            +   '<td>' + (r.makam || '') + '</td>'
            +   '<td><span class="badge bg-secondary">' + form + '</span></td>'
            +   '<td>' + (r.usul || '') + '</td>'
            +   '<td>' + (r.bestekar || '') + '</td>'
            +   '<td id="' + nid + '">' + linkHtml + '</td>'
            + '</tr>';
        }).join('');

        applyHeaderSortClasses();
        renderPagination(totalPages);

        pageRows.forEach(function(r){
          if (!r || r.id == null) return;
          if (assetCache.has(r.id)) return;
          resolveAsset(r).then(function(url){
            if (!url) return;
            assetCache.set(r.id, url);
            var nid = 'asset-' + String(r.id).replace(/[^a-zA-Z0-9_-]/g,'');
            var cell = document.getElementById(nid);
            if (cell) cell.innerHTML = linkHtmlForUrl(url);
          });
        });
      } catch (err) {
        console.error('Render error:', err);
        tbody.innerHTML = '';
      }
    }

    async function resolveAsset(r) {
      if (r.url && typeof r.url === 'string') return r.url;
      var fileField = r.dosya || r.file;
      if (fileField && typeof fileField === 'string') {
        if (/^https?:\/\//i.test(fileField)) return fileField;
        return 'notalar/' + fileField;
      }
      if (r.ext && typeof r.ext === 'string') return 'notalar/' + r.id + '.' + r.ext.replace(/^\./,'');
      for (var i = 0; i < CANDIDATE_EXTS.length; i++) {
        var ext = CANDIDATE_EXTS[i];
        var url = 'notalar/' + r.id + '.' + ext;
        try {
          var resp = await fetch(url, { method: 'HEAD', cache: 'no-store' });
          if (resp.ok) return url;
        } catch (e) {}
      }
      return null;
    }

    function applyFilters() {
      state.currentPage = 1;
      render(state.rows);
    }

    if (randomPieceBtn) {
      randomPieceBtn.addEventListener('click', function(){
        if (!state.rows.length) return;
        var randomIndex = Math.floor(Math.random() * state.rows.length);
        var randomPiece = state.rows[randomIndex];
        q.value = randomPiece.eser;
        applyFilters();
        q.focus();
        q.select();
      });
    }

    // Event listeners (liste)
    if (q) q.addEventListener('input', applyFilters);
    if (makamFilter) makamFilter.addEventListener('change', function (e) { state.activeFilters.makam = e.target.value; applyFilters(); });
    if (composerFilter) composerFilter.addEventListener('change', function (e) { state.activeFilters.composer = e.target.value; applyFilters(); });
    if (usulFilter) usulFilter.addEventListener('change', function (e) { state.activeFilters.usul = e.target.value; applyFilters(); });
    if (formFilter) formFilter.addEventListener('change', function (e) { state.activeFilters.form = e.target.value; applyFilters(); });

    Array.prototype.forEach.call(document.querySelectorAll('.sortable'), function(th){
      th.addEventListener('click', function(){
        var column = th.getAttribute('data-sort');
        if (state.sortColumn === column) {
          state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortColumn = column;
          state.sortDirection = 'asc';
        }
        state.currentPage = 1;
        applyHeaderSortClasses();
        applyFilters();
      });
    });

    // Blog: index yükleme ve liste
    function loadBlogIndex() {
      if (blogIndexLoaded) return Promise.resolve(blogPosts);
      return fetch('blog.json', { cache: 'no-store' })
        .then(function(r){ return r.ok ? r.json() : []; })
        .then(function(list){
          if (!Array.isArray(list)) list = [];
          // Tarihe göre yeni -> eski
          list.sort(function(a,b){ return cmpTR(b.date || '', a.date || ''); });
          blogPosts = list;
          blogIndexLoaded = true;
          return blogPosts;
        })
        .catch(function(){ blogPosts = []; blogIndexLoaded = true; return blogPosts; });
    }

    function renderBlogList() {
      var ul = document.getElementById('blogList');
      if (!ul) return;
      if (!blogPosts.length) {
        ul.innerHTML = '<li class="list-group-item text-secondary">Henüz blog yazısı yok.</li>';
        return;
      }
      ul.innerHTML = blogPosts.map(function(p){
        var href = '#/blog/' + encodeURIComponent(p.slug);
        var date = p.date ? ' — <small class="text-secondary">' + p.date + '</small>' : '';
        return '<li class="list-group-item d-flex justify-content-between align-items-start">'
             + '  <div class="me-auto"><a href="'+href+'" class="fw-semibold">' + (p.title || p.slug) + '</a>' + date + '</div>'
             + '</li>';
      }).join('');
    }

    function renderMarkdownTo(el, mdText, title, meta) {
      if (!el) return;
      try {
        if (typeof marked !== 'undefined') {
          var html = marked.parse(mdText || '');
          var head = '';
          if (title) head += '<h3 class="blog-title">' + title + '</h3>';
          if (meta)  head += '<div class="blog-meta">' + meta + '</div>';
          el.innerHTML = head + html;
        } else {
          el.textContent = mdText || '';
        }
      } catch (e) {
        el.textContent = mdText || '';
      }
    }

    function renderBlogPost(slug) {
      var contentEl = document.getElementById('blogContent');
      if (!contentEl) return;
      loadBlogIndex().then(function(){
        var i, found = null;
        for (i = 0; i < blogPosts.length; i++) if (blogPosts[i].slug === slug) { found = blogPosts[i]; break; }
        if (!found) {
          contentEl.innerHTML = '<div class="alert alert-warning">Yazı bulunamadı.</div>';
          return;
        }
        contentEl.innerHTML = '<div class="text-secondary">Yükleniyor…</div>';
        fetch(found.file, { cache: 'no-store' })
          .then(function(r){ return r.ok ? r.text() : '# Hata\nİçerik yüklenemedi.'; })
          .then(function(md){
            renderMarkdownTo(contentEl, md, found.title || found.slug, found.date || '');
          })
          .catch(function(){
            contentEl.innerHTML = '<div class="alert alert-danger">İçerik yüklenemedi.</div>';
          });
      });
    }

    function renderPage(name) {
      var map = { 'hakkinda': 'pages/hakkinda.md', 'iletisim': 'pages/iletisim.md' };
      var file = map[name];
      var el = document.getElementById('pageContent');
      if (!file || !el) return;
      el.innerHTML = '<div class="text-secondary">Yükleniyor…</div>';
      fetch(file, { cache: 'no-store' })
        .then(function(r){ return r.ok ? r.text() : '# Hata\nSayfa bulunamadı.'; })
        .then(function(md){
          var title = name === 'hakkinda' ? 'Hakkında' : 'İletişim';
          renderMarkdownTo(el, md, '<span class="badge text-bg-secondary me-2">'+title+'</span>', '');
        })
        .catch(function(){
          el.innerHTML = '<div class="alert alert-danger">Sayfa yüklenemedi.</div>';
        });
    }

    // Router
    function setActiveMenu(key) {
      var links = document.querySelectorAll('a.nav-link, .navbar-brand');
      for (var i = 0; i < links.length; i++) {
        var k = links[i].getAttribute('data-nav');
        if (!k) { links[i].classList.remove('active'); continue; }
        links[i].classList.toggle('active', k === key);
      }
      // Mobil menüyü kapat
      var nav = document.getElementById('navbarMain');
      if (nav && typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
        var inst = bootstrap.Collapse.getOrCreateInstance(nav, { toggle: false });
        inst.hide();
      }
    }

    function showView(which) {
      if (viewHome) viewHome.classList.add('d-none');
      if (viewBlog) viewBlog.classList.add('d-none');
      if (viewPage) viewPage.classList.add('d-none');
      if (which === 'home' && viewHome) viewHome.classList.remove('d-none');
      if (which === 'blog' && viewBlog) viewBlog.classList.remove('d-none');
      if (which === 'page' && viewPage) viewPage.classList.remove('d-none');
      window.scrollTo(0,0);
    }

    function navigate() {
      var h = location.hash || '#/';
      // Normalleştir
      if (h.indexOf('#') !== 0) h = '#/';
      // #/blog/slug
      if (h.indexOf('#/blog/') === 0) {
        showView('blog'); setActiveMenu('blog');
        var slug = decodeURIComponent(h.substr('#/blog/'.length));
        loadBlogIndex().then(function(){ renderBlogList(); renderBlogPost(slug); });
        return;
      }
      // #/blog
      if (h.indexOf('#/blog') === 0) {
        showView('blog'); setActiveMenu('blog');
        loadBlogIndex().then(function(){ renderBlogList(); });
        var contentEl = document.getElementById('blogContent');
        if (contentEl) contentEl.innerHTML = '<h5 class="text-secondary">Bir yazı seçiniz.</h5>';
        return;
      }
      // #/hakkinda
      if (h.indexOf('#/hakkinda') === 0) {
        showView('page'); setActiveMenu('hakkinda'); renderPage('hakkinda'); return;
      }
      // #/iletisim
      if (h.indexOf('#/iletisim') === 0) {
        showView('page'); setActiveMenu('iletisim'); renderPage('iletisim'); return;
      }
      // default: home
      showView('home'); setActiveMenu('home');
    }

    // Veri yükleme (liste)
    fetch('rows.json', { cache: 'no-store' })
      .then(function(r){ return r.ok ? r.json() : Promise.reject(new Error('rows.json yüklenemedi')); })
      .then(function(rows){
        state.rows = Array.isArray(rows) ? rows : [];
        updateStatistics(state.rows);
        populateFilters(state.rows);
        render(state.rows);
      })
      .catch(function(err){
        console.error('Veri yükleme hatası:', err);
        state.rows = [];
        updateStatistics(state.rows);
        populateFilters(state.rows);
        render(state.rows);
      });

    // Router events
    window.addEventListener('hashchange', navigate);
    window.addEventListener('DOMContentLoaded', navigate);
  </script>
</body>
</html>
