<!doctype html>
<html lang="tr" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSM Nota Arşivi</title>

  <!-- Sayfa yüklenmeden önce temayı ayarla (flicker'ı azaltır) -->
  <script>
    (() => {
      try {
        const stored = localStorage.getItem('theme'); // 'light' | 'dark' | 'auto'
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const initial = stored === 'auto' || !stored ? (prefersDark ? 'dark' : 'light') : stored;
        document.documentElement.setAttribute('data-bs-theme', initial);
      } catch (_) {
        document.documentElement.setAttribute('data-bs-theme', 'light');
      }
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <style>
    /* Sistem bileşenleri için renk düzeni ipucu */
    :root, [data-bs-theme="light"] { color-scheme: light; }
    [data-bs-theme="dark"] { color-scheme: dark; }

    /* Masaüstünde başlığı ve tema seçiciyi aynı hatta hizala */
    header .toolbar {
      gap: .5rem;
    }

    /* Sıralanabilir tablo başlıkları */
    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .sortable:hover {
      background-color: var(--bs-secondary-bg);
    }

    .sort-icon {
      font-size: 0.8em;
      color: #6c757d;
      margin-left: 0.25rem;
    }

    .sortable.sort-asc .sort-icon::before {
      content: "↑";
    }

    .sortable.sort-desc .sort-icon::before {
      content: "↓";
    }

    /* İstatistik kartları */
    #statistics .card {
      transition: transform 0.2s;
    }

    #statistics .card:hover {
      transform: translateY(-2px);
    }

    /* Responsive tablo */
    @media (max-width: 768px) {
      .table th, .table td {
        font-size: 0.875rem;
        padding: 0.5rem 0.25rem;
      }
    }
  </style>
</head>
<body class="bg-body-tertiary">
  <main class="container py-4">
    <header class="mb-4">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div class="text-center text-md-start">
          <h3 class="display-6 fw-bold mb-2 text-center">Klâsik Türk Müziği Nota Arşivi</h1>
          <!--<h2 class="h5 text-secondary mb-0">Hazırlayan: Ali İhsan Çanakoğlu</h2>-->
        </div>

        <!-- Tema seçimli (Açık / Koyu / Sistem) -->
        <div class="toolbar d-flex align-items-center justify-content-center">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              Tema
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
              <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="light">🌞 Açık</button></li>
              <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="dark">🌙 Koyu</button></li>
              <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="auto">🖥️ Sistem</button></li>
            </ul>
          </div>
        </div>
      </div>

      <!--<center><p class="text-secondary mt-3 mb-3 text-center text-md-start">
        Arama yapabilir ve “Nota” sütunundan dosyayı açabilirsiniz.
      </p></center>-->

      <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8 col-lg-6">
          <input id="q" type="search" class="form-control form-control-lg" placeholder="Arama yapabilir ve “Nota” sütunundan dosyayı açabilirsiniz." aria-label="Tabloda ara" />
        </div>
      </div>
    </header>

    <!-- İstatistikler -->
    <section id="statistics" class="mb-4">
      <div class="row g-3">
        <div class="col-6 col-md-2 col-lg-2">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-primary mb-1"><span id="totalPieces">0</span></h5>
              <p class="card-text small text-muted mb-0">Toplam Eser</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-2 col-lg-2">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-danger mb-1"><span id="totalForms">0</span></h5>
              <p class="card-text small text-muted mb-0">Form</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3 col-lg-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-success mb-1"><span id="totalMakams">0</span></h5>
              <p class="card-text small text-muted mb-0">Makam</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3 col-lg-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-warning mb-1"><span id="totalComposers">0</span></h5>
              <p class="card-text small text-muted mb-0">Bestekâr</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-2 col-lg-2">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-info mb-1"><span id="totalUsuls">0</span></h5>
              <p class="card-text small text-muted mb-0">Usûl</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Gelişmiş Filtreleme -->
    <section class="mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="makamFilter" class="form-label">Makam Filtresi</label>
          <select id="makamFilter" class="form-select">
            <option value="">Tümü</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="composerFilter" class="form-label">Bestekâr Filtresi</label>
          <select id="composerFilter" class="form-select">
            <option value="">Tümü</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="usulFilter" class="form-label">Usûl Filtresi</label>
          <select id="usulFilter" class="form-select">
            <option value="">Tümü</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="formFilter" class="form-label">Form Filtresi</label>
          <select id="formFilter" class="form-select">
            <option value="">Tümü</option>
          </select>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-12">
          <small class="text-muted">
            <i class="bi bi-info-circle"></i> Form bilgisi JSON verisinde yer almaktadır.
          </small>
        </div>
      </div>
    </section>

    <div class="table-responsive">
      <table id="tbl" class="table table-hover align-middle" aria-describedby="help">
        <thead class="table-light">
          <tr>
            <th scope="col" class="sortable" data-sort="eser">
              Eser İsmi <i class="sort-icon">⇅</i>
            </th>
            <th scope="col" class="sortable" data-sort="form">
              Form <i class="sort-icon">⇅</i>
            </th>
            <th scope="col" class="sortable" data-sort="makam">
              Makam <i class="sort-icon">⇅</i>
            </th>
            <th scope="col" class="sortable" data-sort="usul">
              Usûl <i class="sort-icon">⇅</i>
            </th>
            <th scope="col" class="sortable" data-sort="bestekar">
              Bestekâr <i class="sort-icon">⇅</i>
            </th>
            <th scope="col">Nota</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Sayfalama -->
    <section class="mt-3">
      <nav aria-label="Sayfalama">
        <ul id="pagination" class="pagination justify-content-center mb-0"></ul>
      </nav>
    </section>

    <!--
    <p id="help" class="text-body-secondary small mt-3">
      <span class="badge text-bg-secondary">İpucu</span>
      Otomatik tespit: notalar/&lt;id&gt;.[pdf|png|jpg|jpeg|gif|tif|tiff|webp].
      Elle belirtmek için rows.json’a "dosya" (örn: "3.tiff") veya tam "url" ekleyin.
    </p>
    -->
  </main>

  <!-- Footer -->
  <footer class="bg-body-tertiary border-top mt-5 text-white">
    <div class="container py-4">
      <div class="row">
        <div class="col-md-6">
          <h6 class="fw-bold">Klasik Türk  Müziği Nota Arşivi</h6>
          <p>
            Bu arşiv, Klasik Türk  Müziği eserlerinin notalarını araştırmacılar ve müzik severlerin 
            erişimine sunmak amacıyla hazırlanmıştır.
          </p>
        </div>
        <div class="col-md-6">
          <h6 class="fw-bold">Önemli Terimler</h6>
          <div>
            <p class="mb-1"><strong>Makam:</strong>Klasik Türk müziğinde ses dizisi sistemi</p>
            <p class="mb-1"><strong>Usûl:</strong>Klasik Türk müziğinde ritim kalıbı</p>
            <p class="mb-1"><strong>Peşrev:</strong> Sözlü eserlere giriş niteliğinde saz eseri</p>
            <p class="mb-0"><strong>Beste:</strong> Klasik Türk müziğinin en büyük formu</p>
          </div>
        </div>
      </div>
      <hr class="my-3">
      <div class="row align-items-center">
        <div class="col-md-6">
          <p class="mb-0">
            © 2025 KTM Nota Arşivi - Hazırlayan: Ali İhsan Çanakoğlu
          </p>
        </div>
        <div class="col-md-6 text-md-end">
          <p class="mb-0">
            Toplam <span id="footerStats">0</span> eser arşivlenmiştir.
          </p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS (Dropdown için gerekli) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Tema yönetimi -->
  <script>
    (() => {
      const mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
      const getStored = () => {
        try { return localStorage.getItem('theme'); } catch { return null; }
      };
      const setStored = (v) => {
        try { localStorage.setItem('theme', v); } catch {}
      };
      const applyTheme = (theme) => {
        if (theme === 'auto') {
          document.documentElement.setAttribute('data-bs-theme', mql && mql.matches ? 'dark' : 'light');
        } else {
          document.documentElement.setAttribute('data-bs-theme', theme);
        }
        // Dropdown aktif öğeyi işaretle
        document.querySelectorAll('[data-bs-theme-value]').forEach(el => {
          el.classList.toggle('active', el.getAttribute('data-bs-theme-value') === theme);
        });
      };

      // Sistem tercihi değişirse ve 'auto' seçiliyse temayı güncelle
      if (mql && mql.addEventListener) {
        mql.addEventListener('change', () => {
          if (getStored() === 'auto') applyTheme('auto');
        });
      }

      // Dropdown click handler
      window.addEventListener('DOMContentLoaded', () => {
        const current = getStored() || 'auto';
        applyTheme(current);
        document.querySelectorAll('[data-bs-theme-value]').forEach(el => {
          el.addEventListener('click', () => {
            const theme = el.getAttribute('data-bs-theme-value');
            setStored(theme);
            applyTheme(theme);
          });
        });
      });
    })();
  </script>

  <!-- Uygulama mantığı -->
  <script>
    const state = { 
      rows: [], 
      filtered: [], 
      sortColumn: null, 
      sortDirection: 'asc',
      activeFilters: {
        makam: '',
        composer: '',
        usul: '',
        form: ''
      },
      currentPage: 1,
      pageSize: 10
    };

    const tbody = document.querySelector('#tbl tbody');
    const q = document.getElementById('q');
    const makamFilter = document.getElementById('makamFilter');
    const composerFilter = document.getElementById('composerFilter');
    const usulFilter = document.getElementById('usulFilter');
    const formFilter = document.getElementById('formFilter');
    const randomPieceBtn = document.getElementById('randomPiece');
    const pagination = document.getElementById('pagination');

    const CANDIDATE_EXTS = ['pdf','png','jpg','jpeg','gif','tif','tiff','webp'];
    const assetCache = new Map(); // id -> url

    // Müzik formu bilgisi JSON verisinde 'form' alanından okunmaktadır.

    // Buton metni her zaman aynı
    function labelForUrl(url) {
      return 'Görüntüle';
    }

    function linkHtmlForUrl(url) {
      return `<a class="btn btn-sm btn-outline-primary" href="${url}" target="_blank" rel="noopener">${labelForUrl(url)}</a>`;
    }

    function normalize(t) {
      return (t || '').toString().toLocaleLowerCase('tr');
    }

    // İstatistikleri güncelle
    function updateStatistics(rows) {
      const uniqueMakams = new Set(rows.map(r => r.makam).filter(Boolean));
      const uniqueComposers = new Set(rows.map(r => r.bestekar).filter(Boolean));
      const uniqueUsuls = new Set(rows.map(r => r.usul).filter(Boolean));
      const uniqueForms = new Set(rows.map(r => r.form).filter(Boolean));

      document.getElementById('totalPieces').textContent = rows.length;
      document.getElementById('totalForms').textContent = uniqueForms.size;
      document.getElementById('totalMakams').textContent = uniqueMakams.size;
      document.getElementById('totalComposers').textContent = uniqueComposers.size;
      document.getElementById('totalUsuls').textContent = uniqueUsuls.size;
      document.getElementById('footerStats').textContent = rows.length;
    }

    // Filtreleri doldur
    function populateFilters(rows) {
      const makams = [...new Set(rows.map(r => r.makam).filter(Boolean))].sort();
      const composers = [...new Set(rows.map(r => r.bestekar).filter(Boolean))].sort();
      const usuls = [...new Set(rows.map(r => r.usul).filter(Boolean))].sort();
      const forms = [...new Set(rows.map(r => r.form).filter(Boolean))].sort();

      makamFilter.innerHTML = '<option value="">Tümü</option>' + 
        makams.map(m => `<option value="${m}">${m}</option>`).join('');
      
      composerFilter.innerHTML = '<option value="">Tümü</option>' + 
        composers.map(c => `<option value="${c}">${c}</option>`).join('');
      
      usulFilter.innerHTML = '<option value="">Tümü</option>' + 
        usuls.map(u => `<option value="${u}">${u}</option>`).join('');
      
      formFilter.innerHTML = '<option value="">Tümü</option>' + 
        forms.map(f => `<option value="${f}">${f}</option>`).join('');
    }

    // Sıralama
    function sortRows(rows, column, direction) {
      return [...rows].sort((a, b) => {
        let valueA = a[column] || '';
        let valueB = b[column] || '';
        
        if (column === 'form') {
          valueA = a.form || '';
          valueB = b.form || '';
        }
        
        valueA = valueA.toString().toLowerCase();
        valueB = valueB.toString().toLowerCase();
        
        if (direction === 'asc') {
          return valueA.localeCompare(valueB, 'tr');
        } else {
          return valueB.localeCompare(valueA, 'tr');
        }
      });
    }

    // Filtreleme
    function filterRows(rows) {
      const searchNeedle = normalize(q.value);
      
      return rows.filter(r => {
        // Arama filtresi
        if (searchNeedle) {
          const hay = [r.eser, r.makam, r.usul, r.bestekar, r.soz].map(normalize).join(' ');
          if (!hay.includes(searchNeedle)) return false;
        }
        
        // Makam filtresi
        if (state.activeFilters.makam && r.makam !== state.activeFilters.makam) {
          return false;
        }
        
        // Bestekâr filtresi
        if (state.activeFilters.composer && r.bestekar !== state.activeFilters.composer) {
          return false;
        }
        
        // Usûl filtresi
        if (state.activeFilters.usul && r.usul !== state.activeFilters.usul) {
          return false;
        }
        
        // Form filtresi (JSON'dan gelen form bilgisi)
        if (state.activeFilters.form && r.form !== state.activeFilters.form) {
          return false;
        }
        
        return true;
      });
    }

    function getPageNumbers(current, totalPages, delta = 2) {
      const range = [];
      const pages = [];
      let last;

      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= current - delta && i <= current + delta)) {
          range.push(i);
        }
      }
      for (const i of range) {
        if (last) {
          if (i - last === 2) {
            pages.push(last + 1);
          } else if (i - last > 2) {
            pages.push('…');
          }
        }
        pages.push(i);
        last = i;
      }
      return pages;
    }

    function renderPagination(totalPages) {
      if (!pagination) return;

      const current = state.currentPage;
      const pages = getPageNumbers(current, totalPages);
      const prevDisabled = current <= 1 ? ' disabled' : '';
      const nextDisabled = current >= totalPages ? ' disabled' : '';

      let html = '';
      html += `
        <li class="page-item${prevDisabled}">
          <a class="page-link" href="#" aria-label="Önceki" data-page="prev">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>`;

      pages.forEach(p => {
        if (p === '…') {
          html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
        } else {
          const active = p === current ? ' active' : '';
          html += `
            <li class="page-item${active}">
              <a class="page-link" href="#" data-page="${p}">${p}</a>
            </li>`;
        }
      });

      html += `
        <li class="page-item${nextDisabled}">
          <a class="page-link" href="#" aria-label="Sonraki" data-page="next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>`;

      pagination.innerHTML = html;
    }

    // Sayfalama tıklamaları
    if (pagination) {
      pagination.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-page]');
        if (!a) return;
        e.preventDefault();

        const totalPages = Math.max(1, Math.ceil((state.filtered?.length || 0) / state.pageSize));
        const p = a.getAttribute('data-page');
        if (p === 'prev') {
          if (state.currentPage > 1) state.currentPage--;
        } else if (p === 'next') {
          if (state.currentPage < totalPages) state.currentPage++;
        } else {
          const num = parseInt(p, 10);
          if (!isNaN(num)) state.currentPage = Math.min(Math.max(num, 1), totalPages);
        }
        render(state.rows);
        // Tabloya kaydır
        document.getElementById('tbl')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    function render(rows) {
      // Filtreleme uygula
      let filteredRows = filterRows(rows);

      // Sıralama uygula
      if (state.sortColumn) {
        filteredRows = sortRows(filteredRows, state.sortColumn, state.sortDirection);
      }

      // Filtrelenmiş küme state'e yaz
      state.filtered = filteredRows;

      // Sayfalama
      const totalPages = Math.max(1, Math.ceil(filteredRows.length / state.pageSize));
      if (state.currentPage > totalPages) state.currentPage = 1;
      const start = (state.currentPage - 1) * state.pageSize;
      const pageRows = filteredRows.slice(start, start + state.pageSize);

      // Satırları çiz
      tbody.innerHTML = pageRows.map(r => {
        const nid = `asset-${String(r.id ?? '').replace(/[^a-zA-Z0-9_-]/g,'')}`;
        const cached = r.id != null ? assetCache.get(r.id) : null;
        const linkHtml = cached ? linkHtmlForUrl(cached) : '<span class="text-secondary">—</span>';
        const form = r.form || '';
        
        return `
          <tr>
            <td>${r.eser || ''}</td>
            <td><span class="badge bg-secondary">${form}</span></td>
            <td>${r.makam || ''}</td>
            <td>${r.usul || ''}</td>
            <td>${r.bestekar || ''}</td>
            <td id="${nid}">${linkHtml}</td>
          </tr>`;
      }).join('');

      // Sayfalama kontrollerini çiz
      renderPagination(totalPages);

      // Bağlantısı olmayan satırlar için arka planda dosya tespiti
      pageRows.forEach(r => {
        if (!r || r.id == null) return;
        if (assetCache.has(r.id)) return;
        resolveAsset(r).then(url => {
          if (!url) return;
          assetCache.set(r.id, url);
          const nid = `asset-${String(r.id).replace(/[^a-zA-Z0-9_-]/g,'')}`;
          const cell = document.getElementById(nid);
          if (cell) cell.innerHTML = linkHtmlForUrl(url);
        });
      });
    }

    async function resolveAsset(r) {
      if (r.url && typeof r.url === 'string') return r.url;

      const fileField = r.dosya || r.file;
      if (fileField && typeof fileField === 'string') {
        if (/^https?:\/\//i.test(fileField)) return fileField;
        return `notalar/${fileField}`;
      }

      if (r.ext && typeof r.ext === 'string') {
        return `notalar/${r.id}.${r.ext.replace(/^\./,'')}`;
      }

      for (const ext of CANDIDATE_EXTS) {
        const url = `notalar/${r.id}.${ext}`;
        try {
          const resp = await fetch(url, { method: 'HEAD', cache: 'no-store' });
          if (resp.ok) return url;
        } catch (_) {}
      }
      return null;
    }

    function applyFilters() {
      state.currentPage = 1; // her filtrelemede başa dön
      render(state.rows);
    }

    // Rastgele eser (jumbotron kaldırıldığı için buton yoksa atlama yap)
    if (randomPieceBtn) {
      randomPieceBtn.addEventListener('click', () => {
        if (state.rows.length === 0) return;
        const randomIndex = Math.floor(Math.random() * state.rows.length);
        const randomPiece = state.rows[randomIndex];
        q.value = randomPiece.eser;
        applyFilters();
        q.focus();
        q.select();
      });
    }

    // Event listeners
    q.addEventListener('input', applyFilters);
    
    makamFilter.addEventListener('change', (e) => {
      state.activeFilters.makam = e.target.value;
      applyFilters();
    });
    
    composerFilter.addEventListener('change', (e) => {
      state.activeFilters.composer = e.target.value;
      applyFilters();
    });
    
    usulFilter.addEventListener('change', (e) => {
      state.activeFilters.usul = e.target.value;
      applyFilters();
    });
    
    formFilter.addEventListener('change', (e) => {
      state.activeFilters.form = e.target.value;
      applyFilters();
    });

    // Tablo başlığı sıralama
    document.querySelectorAll('.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.getAttribute('data-sort');
        
        if (state.sortColumn === column) {
          state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortColumn = column;
          state.sortDirection = 'asc';
        }

        state.currentPage = 1; // sıralamada başa dön
        document.querySelectorAll('.sortable').forEach(header => {
          header.classList.remove('sort-asc', 'sort-desc');
        });
        th.classList.add(state.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
        applyFilters();
      });
    });

    // Veri yükleme
    fetch('rows.json', { cache: 'no-store' })
      .then(r => r.ok ? r.json() : [])
      .then(rows => {
        state.rows = Array.isArray(rows) ? rows : [];
        updateStatistics(state.rows);
        populateFilters(state.rows);
        render(state.rows);
      })
      .catch(() => { 
        state.rows = []; 
        updateStatistics(state.rows);
        populateFilters(state.rows);
        render(state.rows); 
      });
  </script>
</body>
</html>
