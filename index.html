<!doctype html>
<html lang="tr" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSM Nota Arşivi</title>

  <!-- Sayfa yüklenmeden önce temayı ayarla (flicker'ı azaltır) -->
  <script>
    (function () {
      try {
        var stored = localStorage.getItem('theme'); // 'light' | 'dark' | 'auto'
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var initial = stored === 'auto' || !stored ? (prefersDark ? 'dark' : 'light') : stored;
        document.documentElement.setAttribute('data-bs-theme', initial);
      } catch (_) {
        document.documentElement.setAttribute('data-bs-theme', 'light');
      }
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <style>
    /* Sistem bileşenleri için renk düzeni ipucu */
    :root, [data-bs-theme="light"] { color-scheme: light; }
    [data-bs-theme="dark"] { color-scheme: dark; }

    /* Masaüstünde başlığı ve tema seçiciyi aynı hatta hizala */
    header .toolbar { gap: .5rem; }

    /* Sıralanabilir tablo başlıkları */
    .sortable { cursor: pointer; user-select: none; position: relative; }
    .sortable:hover { background-color: var(--bs-secondary-bg); }
    .sort-icon { font-size: 0.8em; color: #6c757d; margin-left: 0.25rem; }
    .sortable.sort-asc .sort-icon::before { content: "↑"; }
    .sortable.sort-desc .sort-icon::before { content: "↓"; }

    /* İstatistik kartları */
    #statistics .card { transition: transform 0.2s; }
    #statistics .card:hover { transform: translateY(-2px); }

    /* Responsive tablo */
    @media (max-width: 768px) {
      .table th, .table td { font-size: 0.875rem; padding: 0.5rem 0.25rem; }
    }
  </style>
</head>
<body class="bg-body-tertiary">
  <main class="container py-4">
    <header class="mb-2">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div class="text-center text-md-start">
          <h3 class="display-6 fw-bold mb-4 text-center">Klâsik Türk Müziği Nota Arşivi</h3>
          <!--<h2 class="h5 text-secondary mb-0">Hazırlayan: Ali İhsan Çanakoğlu</h2>-->
        </div>

        <!-- Tema seçimli (Açık / Koyu / Sistem) -->
        <div class="toolbar d-flex align-items-center justify-content-center">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              Tema
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
              <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="light">🌞 Açık</button></li>
              <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="dark">🌙 Koyu</button></li>
              <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="auto">🖥️ Sistem</button></li>
            </ul>
          </div>
        </div>
      </div>

      <!--<p class="text-secondary mt-3 mb-3 text-center text-md-start">
        Arama yapabilir ve “Nota” sütunundan dosyayı açabilirsiniz.
      </p>-->

      <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6 mb-4">
          <input id="q" type="search" class="form-control form-control-lg" placeholder="Arama yapabilir ve “Nota” sütunundan dosyayı açabilirsiniz." aria-label="Tabloda ara" />
        </div>
      </div>
    </header>

    <!-- İstatistikler -->
    <section id="statistics" class="mb-4">
      <div class="row g-3">
        <div class="col-6 col-md-2 col-lg-2">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-primary mb-1"><span id="totalPieces">0</span></h5>
              <p class="card-text small text-muted mb-0">Toplam Eser</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-2 col-lg-2">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-danger mb-1"><span id="totalForms">0</span></h5>
              <p class="card-text small text-muted mb-0">Form</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3 col-lg-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-success mb-1"><span id="totalMakams">0</span></h5>
              <p class="card-text small text-muted mb-0">Makam</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3 col-lg-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-warning mb-1"><span id="totalComposers">0</span></h5>
              <p class="card-text small text-muted mb-0">Bestekâr</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-2 col-lg-2">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-info mb-1"><span id="totalUsuls">0</span></h5>
              <p class="card-text small text-muted mb-0">Usûl</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Gelişmiş Filtreleme -->
    <section class="mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="makamFilter" class="form-label">Makam Filtresi</label>
          <select id="makamFilter" class="form-select">
            <option value="">Tümü</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="composerFilter" class="form-label">Bestekâr Filtresi</label>
          <select id="composerFilter" class="form-select">
            <option value="">Tümü</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="usulFilter" class="form-label">Usûl Filtresi</label>
          <select id="usulFilter" class="form-select">
            <option value="">Tümü</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="formFilter" class="form-label">Form Filtresi</label>
          <select id="formFilter" class="form-select">
            <option value="">Tümü</option>
          </select>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-12">
          <!--<small class="text-muted">
            <i class="bi bi-info-circle"></i> Form bilgisi JSON verisinde yer almaktadır.
          </small>-->
        </div>
      </div>
    </section>

    <div class="table-responsive">
      <table id="tbl" class="table table-hover align-middle" aria-describedby="help">
        <thead class="table-light">
          <tr>
            <th scope="col" class="sortable" data-sort="eser">
              Eser İsmi <i class="sort-icon">⇅</i>
            </th>
            <!-- Makam sütunu Form'dan önce -->
            <th scope="col" class="sortable" data-sort="makam">
              Makam <i class="sort-icon">⇅</i>
            </th>
            <th scope="col" class="sortable" data-sort="form">
              Form <i class="sort-icon">⇅</i>
            </th>
            <th scope="col" class="sortable" data-sort="usul">
              Usûl <i class="sort-icon">⇅</i>
            </th>
            <th scope="col" class="sortable" data-sort="bestekar">
              Bestekâr <i class="sort-icon">⇅</i>
            </th>
            <th scope="col">Nota</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Sayfalama -->
    <section class="mt-3">
      <nav aria-label="Sayfalama">
        <ul id="pagination" class="pagination justify-content-center mb-0"></ul>
      </nav>
    </section>
  </main>

  <!-- Footer: ana sayfa zemini ile aynı ve beyaz yazı -->
  <footer class="bg-body-tertiary border-top mt-5 text-white">
    <div class="container py-4">
      <div class="row">
        <div class="col-md-6">
          <h6 class="fw-bold">Türk Klasik Müziği Nota Arşivi</h6>
          <p>
            Bu arşiv, Türk Klasik Müziği eserlerinin notalarını araştırmacılar ve müzik severlerin 
            erişimine sunmak amacıyla hazırlanmıştır.
          </p>
        </div>
        <div class="col-md-6">
          <h6 class="fw-bold">Önemli Terimler</h6>
          <div>
            <p class="mb-1"><strong>Makam:</strong> Türk müziğinde ses dizisi sistemi</p>
            <p class="mb-1"><strong>Usûl:</strong> Türk müziğinde ritim kalıbı</p>
            <p class="mb-1"><strong>Peşrev:</strong> Sözlü eserlere giriş niteliğinde instrumental form</p>
            <p class="mb-0"><strong>Beste:</strong> Klasik Türk müziğinin en önemli büyük formu</p>
          </div>
        </div>
      </div>
      <hr class="my-3">
      <div class="row align-items-center">
        <div class="col-md-6">
          <p class="mb-0">© 2025 TSM Nota Arşivi - Hazırlayan: <a href="mailto:aihsan.canakoglu@dpu.edu.tr">Ali İhsan Çanakoğlu</a></p>
        </div>
        <div class="col-md-6 text-md-end">
          <p class="mb-0">Toplam <span id="footerStats">0</span> eser arşivlenmiştir.</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS (Dropdown için gerekli) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Tema yönetimi -->
  <script>
    (function () {
      var mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
      function getStored() { try { return localStorage.getItem('theme'); } catch (e) { return null; } }
      function setStored(v) { try { localStorage.setItem('theme', v); } catch (e) {} }
      function applyTheme(theme) {
        if (theme === 'auto') {
          document.documentElement.setAttribute('data-bs-theme', mql && mql.matches ? 'dark' : 'light');
        } else {
          document.documentElement.setAttribute('data-bs-theme', theme);
        }
        var items = document.querySelectorAll('[data-bs-theme-value]');
        for (var i = 0; i < items.length; i++) {
          var el = items[i];
          el.classList.toggle('active', el.getAttribute('data-bs-theme-value') === theme);
        }
      }
      if (mql && mql.addEventListener) {
        mql.addEventListener('change', function () {
          if (getStored() === 'auto') applyTheme('auto');
        });
      }
      window.addEventListener('DOMContentLoaded', function () {
        var current = getStored() || 'auto';
        applyTheme(current);
        var items = document.querySelectorAll('[data-bs-theme-value]');
        for (var i = 0; i < items.length; i++) {
          items[i].addEventListener('click', function (ev) {
            var theme = ev.currentTarget.getAttribute('data-bs-theme-value');
            setStored(theme);
            applyTheme(theme);
          });
        }
      });
    })();
  </script>

  <!-- Uygulama mantığı -->
  <script>
    // Android uyumluluğu: Türkçe küçük harf/karşılaştırma için güvenli yardımcılar
    function safeLowerTR(s) {
      var str = (s == null ? '' : String(s));
      try { return str.toLocaleLowerCase(['tr']); }
      catch (_) { try { return str.toLocaleLowerCase(); } catch (e) { return str.toLowerCase(); } }
    }
    function cmpTR(a, b) {
      try { return String(a).localeCompare(String(b), 'tr', { sensitivity: 'base' }); }
      catch (_) { try { return String(a).localeCompare(String(b)); } catch (e) { return (a > b) - (a < b); } }
    }

    var state = { 
      rows: [], 
      filtered: [], 
      // Varsayılan: Makam'a göre alfabetik (A→Z)
      sortColumn: 'makam', 
      sortDirection: 'asc',
      activeFilters: { makam: '', composer: '', usul: '', form: '' },
      currentPage: 1,
      pageSize: 10
    };

    var tbody = document.querySelector('#tbl tbody');
    var q = document.getElementById('q');
    var makamFilter = document.getElementById('makamFilter');
    var composerFilter = document.getElementById('composerFilter');
    var usulFilter = document.getElementById('usulFilter');
    var formFilter = document.getElementById('formFilter');
    var randomPieceBtn = document.getElementById('randomPiece');
    var pagination = document.getElementById('pagination');

    var CANDIDATE_EXTS = ['pdf','png','jpg','jpeg','gif','tif','tiff','webp'];
    var assetCache = new Map(); // id -> url

    function labelForUrl(_) { return 'Görüntüle'; }
    function linkHtmlForUrl(url) {
      return '<a class="btn btn-sm btn-outline-primary" href="' + url + '" target="_blank" rel="noopener">' + labelForUrl(url) + '</a>';
    }

    // İstatistikleri güncelle
    function updateStatistics(rows) {
      function uniq(list) {
        var set = new Set();
        for (var i = 0; i < list.length; i++) { if (list[i]) set.add(list[i]); }
        return Array.from(set);
      }
      var uniqueMakams = uniq(rows.map(function(r){ return r.makam; }));
      var uniqueComposers = uniq(rows.map(function(r){ return r.bestekar; }));
      var uniqueUsuls = uniq(rows.map(function(r){ return r.usul; }));
      var uniqueForms = uniq(rows.map(function(r){ return r.form; }));
      document.getElementById('totalPieces').textContent = rows.length;
      document.getElementById('totalForms').textContent = uniqueForms.length;
      document.getElementById('totalMakams').textContent = uniqueMakams.length;
      document.getElementById('totalComposers').textContent = uniqueComposers.length;
      document.getElementById('totalUsuls').textContent = uniqueUsuls.length;
      document.getElementById('footerStats').textContent = rows.length;
    }

    // Filtreleri doldur
    function populateFilters(rows) {
      function uniqueSorted(getter) {
        var set = new Set();
        for (var i = 0; i < rows.length; i++) {
          var v = getter(rows[i]);
          if (v) set.add(v);
        }
        var arr = Array.from(set);
        arr.sort(cmpTR);
        return arr;
      }
      var makams = uniqueSorted(function(r){ return r.makam; });
      var composers = uniqueSorted(function(r){ return r.bestekar; });
      var usuls = uniqueSorted(function(r){ return r.usul; });
      var forms = uniqueSorted(function(r){ return r.form; });

      makamFilter.innerHTML = '<option value="">Tümü</option>' + makams.map(function(m){ return '<option value="'+m+'">'+m+'</option>'; }).join('');
      composerFilter.innerHTML = '<option value="">Tümü</option>' + composers.map(function(c){ return '<option value="'+c+'">'+c+'</option>'; }).join('');
      usulFilter.innerHTML = '<option value="">Tümü</option>' + usuls.map(function(u){ return '<option value="'+u+'">'+u+'</option>'; }).join('');
      formFilter.innerHTML = '<option value="">Tümü</option>' + forms.map(function(f){ return '<option value="'+f+'">'+f+'</option>'; }).join('');
    }

    // Sıralama
    function sortRows(rows, column, direction) {
      var copy = rows.slice();
      copy.sort(function(a, b) {
        var valueA = a[column] == null ? '' : String(a[column]);
        var valueB = b[column] == null ? '' : String(b[column]);
        if (column === 'form') {
          valueA = a.form == null ? '' : String(a.form);
          valueB = b.form == null ? '' : String(b.form);
        }
        var res = cmpTR(valueA, valueB);
        return direction === 'asc' ? res : -res;
      });
      return copy;
    }

    // Filtreleme
    function filterRows(rows) {
      var searchNeedle = safeLowerTR(q.value);
      return rows.filter(function(r){
        if (searchNeedle) {
          var hay = [r.eser, r.makam, r.usul, r.bestekar, r.soz].map(safeLowerTR).join(' ');
          if (hay.indexOf(searchNeedle) === -1) return false;
        }
        if (state.activeFilters.makam && r.makam !== state.activeFilters.makam) return false;
        if (state.activeFilters.composer && r.bestekar !== state.activeFilters.composer) return false;
        if (state.activeFilters.usul && r.usul !== state.activeFilters.usul) return false;
        if (state.activeFilters.form && r.form !== state.activeFilters.form) return false;
        return true;
      });
    }

    function getPageNumbers(current, totalPages, delta) {
      if (delta == null) delta = 2;
      var range = [], pages = [], last;
      for (var i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= current - delta && i <= current + delta)) range.push(i);
      }
      for (var j = 0; j < range.length; j++) {
        var n = range[j];
        if (last) {
          if (n - last === 2) pages.push(last + 1);
          else if (n - last > 2) pages.push('…');
        }
        pages.push(n); last = n;
      }
      return pages;
    }

    function renderPagination(totalPages) {
      if (!pagination) return;
      var current = state.currentPage;
      var pages = getPageNumbers(current, totalPages);
      var prevDisabled = current <= 1 ? ' disabled' : '';
      var nextDisabled = current >= totalPages ? ' disabled' : '';
      var html = '';
      html += ''
        + '<li class="page-item' + prevDisabled + '">'
        + '  <a class="page-link" href="#" aria-label="Önceki" data-page="prev">'
        + '    <span aria-hidden="true">&laquo;</span>'
        + '  </a>'
        + '</li>';
      pages.forEach(function(p){
        if (p === '…') {
          html += '<li class="page-item disabled"><span class="page-link">…</span></li>';
        } else {
          var active = p === current ? ' active' : '';
          html += ''
            + '<li class="page-item' + active + '">'
            + '  <a class="page-link" href="#" data-page="' + p + '">' + p + '</a>'
            + '</li>';
        }
      });
      html += ''
        + '<li class="page-item' + nextDisabled + '">'
        + '  <a class="page-link" href="#" aria-label="Sonraki" data-page="next">'
        + '    <span aria-hidden="true">&raquo;</span>'
        + '  </a>'
        + '</li>';
      pagination.innerHTML = html;
    }

    function applyHeaderSortClasses() {
      var headers = document.querySelectorAll('.sortable');
      for (var i = 0; i < headers.length; i++) headers[i].classList.remove('sort-asc', 'sort-desc');
      if (state.sortColumn) {
        var th = document.querySelector('.sortable[data-sort="' + state.sortColumn + '"]');
        if (th) th.classList.add(state.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
      }
    }

    // Sayfalama tıklamaları
    if (pagination) {
      pagination.addEventListener('click', function (e) {
        var a = e.target.closest && e.target.closest('a[data-page]');
        if (!a) return;
        e.preventDefault();

        var filteredLen = state.filtered && state.filtered.length ? state.filtered.length : 0;
        var totalPages = Math.max(1, Math.ceil(filteredLen / state.pageSize));
        var p = a.getAttribute('data-page');
        if (p === 'prev') {
          if (state.currentPage > 1) state.currentPage--;
        } else if (p === 'next') {
          if (state.currentPage < totalPages) state.currentPage++;
        } else {
          var num = parseInt(p, 10);
          if (!isNaN(num)) state.currentPage = Math.min(Math.max(num, 1), totalPages);
        }
        render(state.rows);
        // Tabloya kaydır
        var tbl = document.getElementById('tbl');
        if (tbl && tbl.scrollIntoView) tbl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    function render(rows) {
      try {
        // Filtreleme uygula
        var filteredRows = filterRows(rows);
        // Sıralama uygula
        if (state.sortColumn) filteredRows = sortRows(filteredRows, state.sortColumn, state.sortDirection);
        // Filtrelenmiş küme state'e yaz
        state.filtered = filteredRows;

        // Sayfalama
        var totalPages = Math.max(1, Math.ceil(filteredRows.length / state.pageSize));
        if (state.currentPage > totalPages) state.currentPage = 1;
        var start = (state.currentPage - 1) * state.pageSize;
        var pageRows = filteredRows.slice(start, start + state.pageSize);

        // Satırları çiz (Makam sütunu Form'dan önce)
        tbody.innerHTML = pageRows.map(function(r){
          var safeId = (r && r.id != null) ? String(r.id) : '';
          safeId = safeId.replace(/[^a-zA-Z0-9_-]/g,'');
          var nid = 'asset-' + safeId;
          var cached = (r && r.id != null) ? assetCache.get(r.id) : null;
          var linkHtml = cached ? linkHtmlForUrl(cached) : '<span class="text-secondary">—</span>';
          var form = r && r.form ? r.form : '';
          return ''
            + '<tr>'
            +   '<td>' + (r.eser || '') + '</td>'
            +   '<td>' + (r.makam || '') + '</td>'
            +   '<td><span class="badge bg-secondary">' + form + '</span></td>'
            +   '<td>' + (r.usul || '') + '</td>'
            +   '<td>' + (r.bestekar || '') + '</td>'
            +   '<td id="' + nid + '">' + linkHtml + '</td>'
            + '</tr>';
        }).join('');

        // Başlıklardaki aktif sıralama oklarını güncelle
        applyHeaderSortClasses();
        // Sayfalama kontrollerini çiz
        renderPagination(totalPages);

        // Bağlantısı olmayan satırlar için arka planda dosya tespiti
        pageRows.forEach(function(r){
          if (!r || r.id == null) return;
          if (assetCache.has(r.id)) return;
          resolveAsset(r).then(function(url){
            if (!url) return;
            assetCache.set(r.id, url);
            var nid = 'asset-' + String(r.id).replace(/[^a-zA-Z0-9_-]/g,'');
            var cell = document.getElementById(nid);
            if (cell) cell.innerHTML = linkHtmlForUrl(url);
          });
        });
      } catch (err) {
        console.error('Render error:', err);
        tbody.innerHTML = '';
      }
    }

    async function resolveAsset(r) {
      if (r.url && typeof r.url === 'string') return r.url;
      var fileField = r.dosya || r.file;
      if (fileField && typeof fileField === 'string') {
        if (/^https?:\/\//i.test(fileField)) return fileField;
        return 'notalar/' + fileField;
      }
      if (r.ext && typeof r.ext === 'string') return 'notalar/' + r.id + '.' + r.ext.replace(/^\./,'');
      for (var i = 0; i < CANDIDATE_EXTS.length; i++) {
        var ext = CANDIDATE_EXTS[i];
        var url = 'notalar/' + r.id + '.' + ext;
        try {
          var resp = await fetch(url, { method: 'HEAD', cache: 'no-store' });
          if (resp.ok) return url;
        } catch (e) {}
      }
      return null;
    }

    function applyFilters() {
      state.currentPage = 1; // her filtrelemede başa dön
      render(state.rows);
    }

    if (randomPieceBtn) {
      randomPieceBtn.addEventListener('click', function(){
        if (!state.rows.length) return;
        var randomIndex = Math.floor(Math.random() * state.rows.length);
        var randomPiece = state.rows[randomIndex];
        q.value = randomPiece.eser;
        applyFilters();
        q.focus();
        q.select();
      });
    }

    // Event listeners
    q.addEventListener('input', applyFilters);
    makamFilter.addEventListener('change', function (e) { state.activeFilters.makam = e.target.value; applyFilters(); });
    composerFilter.addEventListener('change', function (e) { state.activeFilters.composer = e.target.value; applyFilters(); });
    usulFilter.addEventListener('change', function (e) { state.activeFilters.usul = e.target.value; applyFilters(); });
    formFilter.addEventListener('change', function (e) { state.activeFilters.form = e.target.value; applyFilters(); });

    // Tablo başlığı sıralama
    Array.prototype.forEach.call(document.querySelectorAll('.sortable'), function(th){
      th.addEventListener('click', function(){
        var column = th.getAttribute('data-sort');
        if (state.sortColumn === column) {
          state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortColumn = column;
          state.sortDirection = 'asc';
        }
        state.currentPage = 1; // sıralamada başa dön
        applyHeaderSortClasses();
        applyFilters();
      });
    });

    // Veri yükleme
    fetch('rows.json', { cache: 'no-store' })
      .then(function(r){ return r.ok ? r.json() : Promise.reject(new Error('rows.json yüklenemedi')); })
      .then(function(rows){
        state.rows = Array.isArray(rows) ? rows : [];
        updateStatistics(state.rows);
        populateFilters(state.rows);
        render(state.rows);
      })
      .catch(function(err){
        console.error('Veri yükleme hatası:', err);
        state.rows = [];
        updateStatistics(state.rows);
        populateFilters(state.rows);
        render(state.rows);
      });
  </script>
</body>
</html>
