<!doctype html>
<html lang="tr" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSM Nota Arşivi</title>

  <!-- Sayfa yüklenmeden önce temayı ayarla (flicker'ı azaltır) -->
  <script>
    (() => {
      try {
        const stored = localStorage.getItem('theme'); // 'light' | 'dark' | 'auto'
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const initial = stored === 'auto' || !stored ? (prefersDark ? 'dark' : 'light') : stored;
        document.documentElement.setAttribute('data-bs-theme', initial);
      } catch (_) {
        document.documentElement.setAttribute('data-bs-theme', 'light');
      }
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <style>
    /* Sistem bileşenleri için renk düzeni ipucu */
    :root, [data-bs-theme="light"] { color-scheme: light; }
    [data-bs-theme="dark"] { color-scheme: dark; }

    /* Masaüstünde başlığı ve tema seçiciyi aynı hatta hizala */
    header .toolbar {
      gap: .5rem;
    }
  </style>
</head>
<body class="bg-body-tertiary">
  <main class="container py-4">
    <header class="mb-4">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div class="text-center">
          <h3 class="display-6 fw-bold mb-2">Klâsik Türk Müziği Nota Arşivi</h1>
          <h2 class="h5 text-secondary mb-0">Hazırlayan: Ali İhsan Çanakoğlu</h2>
        </div>

        <!-- Tema seçimli (Açık / Koyu / Sistem) -->
        <div class="toolbar d-flex align-items-center justify-content-center">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              Tema
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
              <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="light">🌞 Açık</button></li>
              <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="dark">🌙 Koyu</button></li>
              <li><button type="button" class="dropdown-item d-flex align-items-center gap-2" data-bs-theme-value="auto">🖥️ Sistem</button></li>
            </ul>
          </div>
        </div>
      </div>

      <p class="text-secondary mt-3 mb-3 text-center text-md-start">
        Arama yapabilir ve “Nota” sütunundan dosyayı açabilirsiniz.
      </p>

      <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
          <input id="q" type="search" class="form-control form-control-lg" placeholder="Ara: eser, makam, usul, bestekâr, söz..." aria-label="Tabloda ara" />
        </div>
      </div>
    </header>

    <!-- Koyu/dolgun jumbotron -->
    <section class="my-4">
      <div class="p-5 mb-4 text-bg-dark rounded-3">
        <div class="container-fluid py-5">
          <h1 class="display-6 mb-2">Arşive Hoş Geldiniz</h3>
          <p class="fs-5 mb-4">Klâsik Türk Müziği eserlerini makam, usul, bestekâr veya söz yazarına göre arayın.</p>
          <a class="btn btn-light btn-lg" href="#q">Aramaya Git</a>
        </div>
      </div>
    </section>

    <div class="table-responsive">
      <table id="tbl" class="table table-hover align-middle" aria-describedby="help">
        <thead class="table-light">
          <tr>
            <th scope="col">Eser İsmi</th>
            <th scope="col">Makam</th>
            <th scope="col">Usûl</th>
            <th scope="col">Bestekâr</th>
            <th scope="col">Nota</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!--
    <p id="help" class="text-body-secondary small mt-3">
      <span class="badge text-bg-secondary">İpucu</span>
      Otomatik tespit: notalar/&lt;id&gt;.[pdf|png|jpg|jpeg|gif|tif|tiff|webp].
      Elle belirtmek için rows.json’a "dosya" (örn: "3.tiff") veya tam "url" ekleyin.
    </p>
    -->
  </main>

  <!-- Bootstrap JS (Dropdown için gerekli) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Tema yönetimi -->
  <script>
    (() => {
      const mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
      const getStored = () => {
        try { return localStorage.getItem('theme'); } catch { return null; }
      };
      const setStored = (v) => {
        try { localStorage.setItem('theme', v); } catch {}
      };
      const applyTheme = (theme) => {
        if (theme === 'auto') {
          document.documentElement.setAttribute('data-bs-theme', mql && mql.matches ? 'dark' : 'light');
        } else {
          document.documentElement.setAttribute('data-bs-theme', theme);
        }
        // Dropdown aktif öğeyi işaretle
        document.querySelectorAll('[data-bs-theme-value]').forEach(el => {
          el.classList.toggle('active', el.getAttribute('data-bs-theme-value') === theme);
        });
      };

      // Sistem tercihi değişirse ve 'auto' seçiliyse temayı güncelle
      if (mql && mql.addEventListener) {
        mql.addEventListener('change', () => {
          if (getStored() === 'auto') applyTheme('auto');
        });
      }

      // Dropdown click handler
      window.addEventListener('DOMContentLoaded', () => {
        const current = getStored() || 'auto';
        applyTheme(current);
        document.querySelectorAll('[data-bs-theme-value]').forEach(el => {
          el.addEventListener('click', () => {
            const theme = el.getAttribute('data-bs-theme-value');
            setStored(theme);
            applyTheme(theme);
          });
        });
      });
    })();
  </script>

  <!-- Uygulama mantığı -->
  <script>
    const state = { rows: [], filtered: [] };
    const tbody = document.querySelector('#tbl tbody');
    const q = document.getElementById('q');

    const CANDIDATE_EXTS = ['pdf','png','jpg','jpeg','gif','tif','tiff','webp'];
    const assetCache = new Map(); // id -> url

    // Buton metni her zaman aynı
    function labelForUrl(url) {
      return 'Görüntüle';
    }

    function linkHtmlForUrl(url) {
      return `<a class="btn btn-sm btn-outline-primary" href="${url}" target="_blank" rel="noopener">${labelForUrl(url)}</a>`;
    }

    function normalize(t) {
      return (t || '').toString().toLocaleLowerCase('tr');
    }

    function render(rows) {
      tbody.innerHTML = rows.map(r => {
        const nid = `asset-${String(r.id ?? '').replace(/[^a-zA-Z0-9_-]/g,'')}`;
        const cached = r.id != null ? assetCache.get(r.id) : null;
        const linkHtml = cached ? linkHtmlForUrl(cached) : '<span class="text-secondary">—</span>';
        return `
          <tr>
            <td>${r.eser || ''}</td>
            <td>${r.makam || ''}</td>
            <td>${r.usul || ''}</td>
            <td>${r.bestekar || ''}</td>
            <!--<td>${r.soz || ''}</td>-->
            <td id="${nid}">${linkHtml}</td>
          </tr>`;
      }).join('');

      // Bağlantısı olmayan satırlar için arka planda dosya tespiti
      rows.forEach(r => {
        if (!r || r.id == null) return;
        if (assetCache.has(r.id)) return;
        resolveAsset(r).then(url => {
          if (!url) return;
          assetCache.set(r.id, url);
          const nid = `asset-${String(r.id).replace(/[^a-zA-Z0-9_-]/g,'')}`;
          const cell = document.getElementById(nid);
          if (cell) cell.innerHTML = linkHtmlForUrl(url);
        });
      });
    }

    async function resolveAsset(r) {
      if (r.url && typeof r.url === 'string') return r.url;

      const fileField = r.dosya || r.file;
      if (fileField && typeof fileField === 'string') {
        if (/^https?:\/\//i.test(fileField)) return fileField;
        return `notalar/${fileField}`;
      }

      if (r.ext && typeof r.ext === 'string') {
        return `notalar/${r.id}.${r.ext.replace(/^\./,'')}`;
      }

      for (const ext of CANDIDATE_EXTS) {
        const url = `notalar/${r.id}.${ext}`;
        try {
          const resp = await fetch(url, { method: 'HEAD', cache: 'no-store' });
          if (resp.ok) return url;
        } catch (_) {}
      }
      return null;
    }

    function applyFilter() {
      const needle = normalize(q.value);
      if (!needle) { render(state.rows); return; }
      const rows = state.rows.filter(r => {
        const hay = [r.eser, r.makam, r.usul, r.bestekar, r.soz].map(normalize).join(' ');
        return hay.includes(needle);
      });
      render(rows);
    }

    q.addEventListener('input', applyFilter);

    fetch('rows.json', { cache: 'no-store' })
      .then(r => r.ok ? r.json() : [])
      .then(rows => {
        state.rows = Array.isArray(rows) ? rows : [];
        render(state.rows);
      })
      .catch(() => { state.rows = []; render(state.rows); });
  </script>
</body>
</html>
