<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSM Nota Arşivi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <style>
    :root { color-scheme: light dark; }
  </style>
</head>
<body class="bg-body-tertiary">
  <main class="container py-4">
    <header class="text-center mb-4">
      <h1 class="display-6 mb-1">Klâsik Türk Müziği Nota Arşivi</h1>
      <h2 class="h5 text-secondary mb-3">Ali İhsan Çanakoğlu</h2>
      <p class="text-secondary mb-4">Arama yapabilir ve “Nota” sütunundan dosyayı açabilirsiniz.</p>
      <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
          <input id="q" type="search" class="form-control form-control-lg" placeholder="Ara: eser, makam, usul, bestekâr, söz..." aria-label="Tabloda ara" />
        </div>
      </div>
    </header>

    <div class="table-responsive">
      <table id="tbl" class="table table-hover align-middle" aria-describedby="help">
        <thead class="table-light">
          <tr>
            <th scope="col">Eser</th>
            <th scope="col">Makam</th>
            <th scope="col">Usul</th>
            <th scope="col">Bestekâr</th>
            <th scope="col">Söz</th>
            <th scope="col">Nota</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!--
    <p id="help" class="text-body-secondary small mt-3">
      <span class="badge text-bg-secondary">İpucu</span>
      Otomatik tespit: notalar/&lt;id&gt;.[pdf|png|jpg|jpeg|gif|tif|tiff|webp].
      Elle belirtmek için rows.json’a "dosya" (örn: "3.tiff") veya tam "url" ekleyin.
    </p>
    -->
  </main>

  <script>
    const state = { rows: [], filtered: [] };
    const tbody = document.querySelector('#tbl tbody');
    const q = document.getElementById('q');

    const CANDIDATE_EXTS = ['pdf','png','jpg','jpeg','gif','tif','tiff','webp'];
    const assetCache = new Map(); // id -> url

    function labelForUrl(url) {
      const m = (url || '').toLowerCase().match(/\.([a-z0-9]+)(?:\?|#|$)/);
      const ext = m ? m[1] : '';
      if (ext === 'pdf') return 'PDF';
      if (['png','jpg','jpeg','gif','tif','tiff','webp'].includes(ext)) return 'Görüntü';
      return 'Aç';
    }

    function linkHtmlForUrl(url) {
      return `<a class="btn btn-sm btn-outline-primary" href="${url}" target="_blank" rel="noopener">${labelForUrl(url)}</a>`;
    }

    function normalize(t) {
      return (t || '').toString().toLocaleLowerCase('tr');
    }

    function render(rows) {
      tbody.innerHTML = rows.map(r => {
        const nid = `asset-${String(r.id ?? '').replace(/[^a-zA-Z0-9_-]/g,'')}`;
        const cached = r.id != null ? assetCache.get(r.id) : null;
        const linkHtml = cached
          ? linkHtmlForUrl(cached)
          : '<span class="text-secondary">—</span>';
        return `
          <tr>
            <td>${r.eser || ''}</td>
            <td>${r.makam || ''}</td>
            <td>${r.usul || ''}</td>
            <td>${r.bestekar || ''}</td>
            <td>${r.soz || ''}</td>
            <td id="${nid}">${linkHtml}</td>
          </tr>`;
      }).join('');

      // Bağlantısı olmayan satırlar için arka planda dosya tespiti yap
      rows.forEach(r => {
        if (r == null || r.id == null) return;
        if (assetCache.has(r.id)) return;
        resolveAsset(r).then(url => {
          if (!url) return;
          assetCache.set(r.id, url);
          const nid = `asset-${String(r.id).replace(/[^a-zA-Z0-9_-]/g,'')}`;
          const cell = document.getElementById(nid);
          if (cell) cell.innerHTML = linkHtmlForUrl(url);
        });
      });
    }

    async function resolveAsset(r) {
      // 1) rows.json içinde "url" varsa doğrudan kullan
      if (r.url && typeof r.url === 'string') return r.url;

      // 2) "dosya" (veya "file") verilmişse köke göre birleştir
      const fileField = r.dosya || r.file;
      if (fileField && typeof fileField === 'string') {
        // Tam URL mi yoksa notalar/ içinde bir dosya mı?
        if (/^https?:\/\//i.test(fileField)) return fileField;
        return `notalar/${fileField}`;
      }

      // 3) "ext" verilmişse notalar/<id>.<ext>
      if (r.ext && typeof r.ext === 'string') {
        return `notalar/${r.id}.${r.ext.replace(/^\./,'')}`;
      }

      // 4) Otomatik tespit: olası uzantıları HEAD ile sırayla dene
      for (const ext of CANDIDATE_EXTS) {
        const url = `notalar/${r.id}.${ext}`;
        try {
          const resp = await fetch(url, { method: 'HEAD', cache: 'no-store' });
          if (resp.ok) return url;
        } catch (_) {}
      }
      return null;
    }

    function applyFilter() {
      const needle = normalize(q.value);
      if (!needle) { render(state.rows); return; }
      const rows = state.rows.filter(r => {
        const hay = [r.eser, r.makam, r.usul, r.bestekar, r.soz].map(normalize).join(' ');
        return hay.includes(needle);
      });
      render(rows);
    }

    q.addEventListener('input', applyFilter);

    fetch('rows.json', { cache: 'no-store' })
      .then(r => r.ok ? r.json() : [])
      .then(rows => {
        state.rows = Array.isArray(rows) ? rows : [];
        render(state.rows);
      })
      .catch(() => { state.rows = []; render(state.rows); });
  </script>
</body>
</html>
